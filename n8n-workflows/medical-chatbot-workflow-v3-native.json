{
  "name": "Medical Chatbot - Vietnamese",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "medical-chat",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-1",
      "name": "Webhook - Chat Input",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "medical-chat-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Phát hiện triệu chứng từ tin nhắn tiếng Việt\nconst message = $input.first().json.message?.toLowerCase() || '';\nconst userId = $input.first().json.userId || 'anonymous';\nconst sessionId = $input.first().json.sessionId || Date.now().toString();\n\n// Dictionary triệu chứng tiếng Việt\nconst symptomKeywords = {\n  'đau_đầu': ['đau đầu', 'nhức đầu', 'migraine', 'headache', 'đau nửa đầu'],\n  'sốt': ['sốt', 'fever', 'nóng người', 'ốm', 'bị sốt'],\n  'ho': ['ho', 'cough', 'ho khan', 'ho có đờm', 'ho nhiều'],\n  'đau_bụng': ['đau bụng', 'stomach pain', 'đau dạ dày', 'đau tụt'],\n  'cảm_lạnh': ['cảm lạnh', 'cold', 'flu', 'cúm', 'nghẹt mũi'],\n  'mụn_trứng_cá': ['mụn', 'acne', 'mụn trứng cá', 'da mụn', 'mụn mủ'],\n  'tiêu_chảy': ['tiêu chảy', 'diarrhea', 'đi lỏng', 'đi nước'],\n  'táo_bón': ['táo bón', 'constipation', 'khó đi đại tiện', 'đại tiện khó'],\n  'viêm_họng': ['viêm họng', 'sore throat', 'đau họng', 'họng đau'],\n  'chóng_mặt': ['chóng mặt', 'dizzy', 'hoa mắt', 'đầu quay'],\n  'đau_răng': ['đau răng', 'toothache', 'nhức răng', 'răng đau'],\n  'mất_ngủ': ['mất ngủ', 'insomnia', 'không ngủ được', 'khó ngủ'],\n  'stress': ['stress', 'căng thẳng', 'lo âu', 'anxiety'],\n  'đau_lưng': ['đau lưng', 'back pain', 'lưng đau', 'nhức lưng']\n};\n\n// Phát hiện triệu chứng\nlet detectedSymptoms = [];\nfor (let symptom in symptomKeywords) {\n  for (let keyword of symptomKeywords[symptom]) {\n    if (message.includes(keyword)) {\n      detectedSymptoms.push(symptom);\n      break;\n    }\n  }\n}\n\n// Xác định độ nặng dựa trên từ khóa\nlet severity = 'mild';\nif (message.includes('rất') || message.includes('nhiều') || message.includes('nặng') || message.includes('khủng khiếp')) {\n  severity = 'severe';\n} else if (message.includes('hơi') || message.includes('nhẹ') || message.includes('ít')) {\n  severity = 'mild';\n} else {\n  severity = 'moderate';\n}\n\n// Loại bỏ duplicate symptoms\ndetectedSymptoms = [...new Set(detectedSymptoms)];\n\nreturn {\n  json: {\n    originalMessage: $input.first().json.message,\n    detectedSymptoms: detectedSymptoms,\n    severity: severity,\n    userId: userId,\n    sessionId: sessionId,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "code-symptom-detection",
      "name": "Symptom Detection",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// Load medical dataset - Embed data trực tiếp\nconst medicalDataSample = [\n  {\n    \"drug_name\": \"Paracetamol\",\n    \"medical_condition\": \"Pain\",\n    \"medical_condition_vi\": \"đau đầu\",\n    \"side_effects_vi\": \"buồn nôn, chóng mặt\",\n    \"drug_classes_vi\": \"thuốc giảm đau\",\n    \"rx_otc\": \"OTC\",\n    \"rating\": 8.5\n  },\n  {\n    \"drug_name\": \"Aspirin\",\n    \"medical_condition\": \"Headache\", \n    \"medical_condition_vi\": \"đau đầu\",\n    \"side_effects_vi\": \"đau dạ dày\",\n    \"drug_classes_vi\": \"thuốc chống viêm\",\n    \"rx_otc\": \"OTC\",\n    \"rating\": 7.8\n  },\n  {\n    \"drug_name\": \"Ibuprofen\",\n    \"medical_condition\": \"Pain\",\n    \"medical_condition_vi\": \"đau đầu\",\n    \"side_effects_vi\": \"buồn nôn\",\n    \"drug_classes_vi\": \"thuốc giảm đau\",\n    \"rx_otc\": \"OTC\",\n    \"rating\": 8.2\n  },\n  {\n    \"drug_name\": \"Cough Syrup\",\n    \"medical_condition\": \"Cough\",\n    \"medical_condition_vi\": \"ho\",\n    \"side_effects_vi\": \"buồn ngủ\",\n    \"drug_classes_vi\": \"thuốc ho\",\n    \"rx_otc\": \"OTC\",\n    \"rating\": 7.5\n  },\n  {\n    \"drug_name\": \"Fever Reducer\",\n    \"medical_condition\": \"Fever\",\n    \"medical_condition_vi\": \"sốt\",\n    \"side_effects_vi\": \"chóng mặt\",\n    \"drug_classes_vi\": \"thuốc hạ sốt\",\n    \"rx_otc\": \"OTC\",\n    \"rating\": 8.0\n  },\n  {\n    \"drug_name\": \"Antacid\",\n    \"medical_condition\": \"Stomach Pain\",\n    \"medical_condition_vi\": \"đau bụng\",\n    \"side_effects_vi\": \"táo bón\",\n    \"drug_classes_vi\": \"thuốc dạ dày\",\n    \"rx_otc\": \"OTC\",\n    \"rating\": 7.3\n  }\n];\n\n// Lấy data từ node trước\nconst symptoms = $input.first().json.detectedSymptoms;\nconst severity = $input.first().json.severity;\n\n// TODO: Thay thế medicalDataSample bằng full dataset\n// Có thể load từ HTTP Request node hoặc embed full JSON\nconst medicalData = medicalDataSample;\n\nlet foundDrugs = [];\n\n// Tìm kiếm thuốc cho từng triệu chứng\nfor (let symptom of symptoms) {\n  const symptomSearch = symptom.replace('_', ' ');\n  \n  const matchingDrugs = medicalData.filter(drug => {\n    const condition = (drug.medical_condition_vi || '').toLowerCase();\n    const conditionEn = (drug.medical_condition || '').toLowerCase();\n    \n    return condition.includes(symptomSearch) || \n           conditionEn.includes(symptomSearch) ||\n           condition.includes(symptom.replace('_', ''));\n  });\n  \n  foundDrugs.push(...matchingDrugs);\n}\n\n// Sắp xếp theo rating và ưu tiên OTC cho severity nhẹ\nfoundDrugs.sort((a, b) => {\n  // Ưu tiên OTC cho triệu chứng nhẹ\n  if (severity === 'mild') {\n    if (a.rx_otc === 'OTC' && b.rx_otc !== 'OTC') return -1;\n    if (b.rx_otc === 'OTC' && a.rx_otc !== 'OTC') return 1;\n  }\n  // Sắp xếp theo rating\n  return (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0);\n});\n\n// Loại bỏ duplicate dựa trên drug_name\nconst uniqueDrugs = foundDrugs.filter((drug, index, self) => \n  index === self.findIndex(d => d.drug_name === drug.drug_name)\n);\n\nreturn {\n  json: {\n    symptoms: symptoms,\n    severity: severity,\n    recommendedDrugs: uniqueDrugs.slice(0, 5), // Top 5 recommendations\n    totalFound: uniqueDrugs.length,\n    userId: $input.first().json.userId,\n    sessionId: $input.first().json.sessionId,\n    searchTimestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "code-drug-search",
      "name": "Drug Search Engine",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "// Tạo phản hồi thân thiện bằng tiếng Việt\nconst symptoms = $input.first().json.symptoms || [];\nconst drugs = $input.first().json.recommendedDrugs || [];\nconst severity = $input.first().json.severity;\nconst originalMessage = $input.first().json.originalMessage || '';\n\nlet response = \"\";\nlet responseType = \"\";\n\nif (symptoms.length === 0) {\n  responseType = \"no_symptoms\";\n  response = `Xin chào! Tôi không thể xác định triệu chứng cụ thể từ tin nhắn: \"${originalMessage}\".\\n\\n`;\n  response += `Bạn có thể mô tả rõ hơn triệu chứng của mình không? Ví dụ:\\n`;\n  response += `• \"Tôi bị đau đầu\"\\n`;\n  response += `• \"Tôi bị sốt và ho\"\\n`;\n  response += `• \"Tôi bị đau bụng\"\\n\\n`;\n  response += `Tôi có thể giúp tư vấn thuốc cho các triệu chứng phổ biến! 😊`;\n} else if (drugs.length === 0) {\n  responseType = \"no_drugs\";\n  const symptomText = symptoms.map(s => s.replace(/_/g, ' ')).join(', ');\n  response = `Tôi đã hiểu bạn có triệu chứng: **${symptomText}**.\\n\\n`;\n  response += `Tuy nhiên, tôi không tìm thấy thuốc phù hợp trong cơ sở dữ liệu hiện tại.\\n\\n`;\n  response += `🏥 **Gợi ý:**\\n`;\n  response += `• Thăm khám bác sĩ để được tư vấn chính xác\\n`;\n  response += `• Liên hệ dược sĩ tại nhà thuốc gần nhất\\n`;\n  response += `• Gọi hotline y tế: 19003116`;\n} else {\n  responseType = \"recommendations\";\n  const symptomText = symptoms.map(s => s.replace(/_/g, ' ')).join(', ');\n  const severityText = severity === 'mild' ? 'nhẹ' : severity === 'severe' ? 'nặng' : 'vừa phải';\n  \n  response = `Dựa trên triệu chứng **\"${symptomText}\"** (mức độ: ${severityText}), tôi gợi ý các thuốc sau:\\n\\n`;\n  \n  drugs.forEach((drug, index) => {\n    response += `**${index + 1}. ${drug.drug_name}** `;\n    response += `${drug.rx_otc === 'OTC' ? '🟢' : '🔴'} ${drug.rx_otc}\\n`;\n    \n    if (drug.medical_condition_vi) {\n      response += `   📋 Dùng cho: ${drug.medical_condition_vi}\\n`;\n    }\n    \n    if (drug.drug_classes_vi) {\n      response += `   💊 Loại thuốc: ${drug.drug_classes_vi}\\n`;\n    }\n    \n    if (drug.rating) {\n      const stars = '⭐'.repeat(Math.round(parseFloat(drug.rating) / 2));\n      response += `   ${stars} Đánh giá: ${drug.rating}/10\\n`;\n    }\n    \n    if (drug.side_effects_vi) {\n      response += `   ⚠️ Tác dụng phụ: ${drug.side_effects_vi}\\n`;\n    }\n    \n    response += `\\n`;\n  });\n  \n  response += `\\n🛡️ **LưU Ý QUAN TRỌNG:**\\n`;\n  response += `• 🟢 OTC: Không cần toa bác sĩ\\n`;\n  response += `• 🔴 Rx: Cần có toa bác sĩ\\n`;\n  response += `• Thông tin này chỉ mang tính chất tham khảo\\n`;\n  response += `• Tham khảo ý kiến bác sĩ/dược sĩ trước khi sử dụng\\n`;\n  response += `• Đọc kỹ hướng dẫn sử dụng\\n`;\n  response += `• Ngưng sử dụng nếu có phản ứng bất thường\\n\\n`;\n  \n  if (severity === 'severe') {\n    response += `🚨 **CẢNH BÁO**: Triệu chứng nặng - Nên thăm khám bác sĩ ngay!`;\n  }\n}\n\nreturn {\n  json: {\n    response: response,\n    responseType: responseType,\n    metadata: {\n      symptoms: symptoms,\n      symptomsCount: symptoms.length,\n      drugsFound: drugs.length,\n      severity: severity,\n      originalMessage: originalMessage,\n      timestamp: new Date().toISOString(),\n      language: 'vi'\n    },\n    userId: $input.first().json.userId,\n    sessionId: $input.first().json.sessionId\n  }\n};"
      },
      "id": "code-response-generator", 
      "name": "Response Generator",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": true,\n  \"message\": \"{{ $json.response }}\",\n  \"metadata\": {\n    \"symptoms\": {{ $json.metadata.symptoms }},\n    \"drugsFound\": {{ $json.metadata.drugsFound }},\n    \"severity\": \"{{ $json.metadata.severity }}\",\n    \"responseType\": \"{{ $json.responseType }}\",\n    \"timestamp\": \"{{ $json.metadata.timestamp }}\"\n  },\n  \"userId\": \"{{ $json.userId }}\",\n  \"sessionId\": \"{{ $json.sessionId }}\"\n}",
        "options": {
          "headers": {
            "Content-Type": "application/json; charset=utf-8"
          }
        }
      },\n\
    {,"id\": \"webhook-response\",\n      \"name\": \"Webhook Response\",\n      \"type\": \"n8n-nodes-base.webhookResponse\",\n      \"typeVersion\": 1,\n      \"position\": [1120, 300]\n    },\n    {\n      \"parameters\": {\n        \"mode\": \"raw\",\n        \"jsonOutput\": \"[\\n  {\\n    \\\"drug_name\\\": \\\"Paracetamol\\\",\\n    \\\"medical_condition\\\": \\\"Pain\\\",\\n    \\\"medical_condition_vi\\\": \\\"đau đầu\\\",\\n    \\\"side_effects_vi\\\": \\\"buồn nôn, chóng mặt\\\",\\n    \\\"drug_classes_vi\\\": \\\"thuốc giảm đau\\\",\\n    \\\"rx_otc\\\": \\\"OTC\\\",\\n    \\\"rating\\\": 8.5\\n  },\\n  {\\n    \\\"drug_name\\\": \\\"Aspirin\\\",\\n    \\\"medical_condition\\\": \\\"Headache\\\", \\n    \\\"medical_condition_vi\\\": \\\"đau đầu\\\",\\n    \\\"side_effects_vi\\\": \\\"đau dạ dày\\\",\\n    \\\"drug_classes_vi\\\": \\\"thuốc chống viêm\\\",\\n    \\\"rx_otc\\\": \\\"OTC\\\",\\n    \\\"rating\\\": 7.8\\n  }\\n]\",\n        \"options\": {}\n      },\n      \"id\": \"set-medical-data\",\n      \"name\": \"Medical Dataset\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"typeVersion\": 3.3,\n      \"position\": [680, 480],\n      \"disabled\": true\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Log để debug và monitoring\\nconst inputData = $input.first().json;\\n\\nconsole.log('=== MEDICAL CHATBOT LOG ===');\\nconsole.log('Timestamp:', new Date().toISOString());\\nconsole.log('User ID:', inputData.userId);\\nconsole.log('Session ID:', inputData.sessionId);\\nconsole.log('Original Message:', inputData.originalMessage);\\nconsole.log('Detected Symptoms:', inputData.symptoms);\\nconsole.log('Severity:', inputData.severity);\\nconsole.log('Drugs Found:', inputData.metadata?.drugsFound || 0);\\nconsole.log('Response Type:', inputData.responseType);\\nconsole.log('============================');\\n\\n// Có thể gửi log lên external service nếu cần\\n// hoặc lưu vào database để analytics\\n\\nreturn $input.all();\"\n      },\n      \"id\": \"code-logger\",\n      \"name\": \"Debug Logger\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [900, 480]\n    }\n  ],\n  \"connections\": {\n    \"Webhook - Chat Input\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Symptom Detection\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Symptom Detection\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Drug Search Engine\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Drug Search Engine\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Response Generator\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Response Generator\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Webhook Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Debug Logger\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"pinData\": {},\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"staticData\": null,\n  \"tags\": [\n    {\n      \"createdAt\": \"2025-10-10T10:00:00.000Z\",\n      \"updatedAt\": \"2025-10-10T10:00:00.000Z\",\n      \"id\": \"1\",\n      \"name\": \"medical\"\n    },\n    {\n      \"createdAt\": \"2025-10-10T10:00:00.000Z\",\n      \"updatedAt\": \"2025-10-10T10:00:00.000Z\",\n      \"id\": \"2\",\n      \"name\": \"vietnamese\"\n    }\n  ],\n  \"triggerCount\": 1,\n  \"updatedAt\": \"2025-10-10T10:00:00.000Z\",\n  \"versionId\": \"v3-medical-vietnamese\"\n}