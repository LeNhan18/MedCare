{
  "name": "Medical Chatbot Workflow - Vietnamese",
  "nodes": [
    {
      "parameters": {},
      "id": "0c6b1b2e-8f4c-4a1a-9b3d-2e5f6a7b8c9d",
      "name": "When clicking 'Test workflow'",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [820, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "medical-chat",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "1d7c2c3f-9e5d-4b2b-ac4e-3f6e7b8c9d0e",
      "name": "Webhook - Chat Input",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [580, 300],
      "webhookId": "medical-chatbot-webhook"
    },
    {
      "parameters": {
        "jsCode": "// X·ª≠ l√Ω tin nh·∫Øn ƒë·∫ßu v√†o t·ª´ ng∆∞·ªùi d√πng\nconst userMessage = $input.all()[0].json.body.message || $input.all()[0].json.message || 'T√¥i c·∫ßn t∆∞ v·∫•n thu·ªëc';\nconst userId = $input.all()[0].json.body.userId || $input.all()[0].json.userId || 'user_001';\nconst sessionId = $input.all()[0].json.body.sessionId || Date.now().toString();\n\n// L√†m s·∫°ch v√† chu·∫©n h√≥a tin nh·∫Øn\nconst cleanMessage = userMessage.toLowerCase()\n  .replace(/[^\\w√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë\\s]/gi, '')\n  .trim();\n\n// Ph√°t hi·ªán √Ω ƒë·ªãnh (Intent Detection)\nlet intent = 'general_inquiry';\nlet symptoms = [];\nlet severity = 'mild';\n\n// T·ª´ kh√≥a tri·ªáu ch·ª©ng ph·ªï bi·∫øn\nconst symptomKeywords = {\n  'ƒëau_ƒë·∫ßu': ['ƒëau ƒë·∫ßu', 'nh·ª©c ƒë·∫ßu', 'ƒëau n·ª≠a ƒë·∫ßu', 'migraine', 'headache'],\n  's·ªët': ['s·ªët', 'n√≥ng s·ªët', 'fever', 'b·ªëc h·ªèa'],\n  'ho': ['ho', 'cough', 'ho khan', 'ho c√≥ ƒë·ªùm'],\n  'ƒëau_b·ª•ng': ['ƒëau b·ª•ng', 'ƒëau d·∫° d√†y', 'stomach pain', 'ƒëau t·ª•y'],\n  'm·ª•n_tr·ª©ng_c√°': ['m·ª•n', 'm·ª•n tr·ª©ng c√°', 'acne', 'm·ª•n ƒë·∫ßu ƒëen'],\n  'gi·∫£m_c√¢n': ['gi·∫£m c√¢n', 'b√©o ph√¨', 'weight loss', 'diet', 'slim'],\n  'ti√™u_ch·∫£y': ['ti√™u ch·∫£y', 'diarrhea', 'ƒëi ngo√†i', 'l·ªèng'],\n  't√°o_b√≥n': ['t√°o b√≥n', 'constipation', 'kh√≥ ƒëi ngo√†i'],\n  'd·ªã_·ª©ng': ['d·ªã ·ª©ng', 'allergy', 'ph√°t ban', 'ng·ª©a'],\n  'c·∫£m_c√∫m': ['c·∫£m c√∫m', 'c·∫£m l·∫°nh', 'flu', 'cold', 'ngh·∫πt m≈©i']\n};\n\n// Ph√°t hi·ªán tri·ªáu ch·ª©ng trong tin nh·∫Øn\nfor (const [symptom, keywords] of Object.entries(symptomKeywords)) {\n  for (const keyword of keywords) {\n    if (cleanMessage.includes(keyword)) {\n      symptoms.push(symptom);\n      intent = 'symptom_inquiry';\n      break;\n    }\n  }\n}\n\n// Ph√°t hi·ªán m·ª©c ƒë·ªô nghi√™m tr·ªçng\nif (cleanMessage.includes('r·∫•t ƒëau') || cleanMessage.includes('severe') || cleanMessage.includes('d·ªØ d·ªôi')) {\n  severity = 'severe';\n} else if (cleanMessage.includes('kh√° ƒëau') || cleanMessage.includes('moderate') || cleanMessage.includes('v·ª´a')) {\n  severity = 'moderate';\n}\n\n// Ph√°t hi·ªán c√°c √Ω ƒë·ªãnh kh√°c\nif (cleanMessage.includes('t√°c d·ª•ng ph·ª•') || cleanMessage.includes('side effect')) {\n  intent = 'side_effects_inquiry';\n} else if (cleanMessage.includes('li·ªÅu d√πng') || cleanMessage.includes('dosage') || cleanMessage.includes('c√°ch u·ªëng')) {\n  intent = 'dosage_inquiry';\n} else if (cleanMessage.includes('t∆∞∆°ng t√°c thu·ªëc') || cleanMessage.includes('drug interaction')) {\n  intent = 'drug_interaction';\n}\n\nreturn {\n  json: {\n    userId: userId,\n    sessionId: sessionId,\n    originalMessage: userMessage,\n    cleanMessage: cleanMessage,\n    intent: intent,\n    symptoms: symptoms,\n    severity: severity,\n    timestamp: new Date().toISOString(),\n    language: 'vi'\n  }\n};"
      },
      "id": "2e8d3d4e-af6e-5c3c-bd5f-4e7f8c9d0e1f",
      "name": "Process User Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [820, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "intent_symptom",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "symptom_inquiry",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3f9e4e5f-be7f-6d4d-ce6e-5f8e9d0e1f2e",
      "name": "Route by Intent",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1060, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:3001/api/search-drugs",
        "sendQuery": false,
        "sendHeaders": false,
        "sendBody": true,
        "contentType": "json",
        "body": "={\n  \"symptoms\": {{ JSON.stringify($json.symptoms) }},\n  \"severity\": \"{{ $json.severity }}\",\n  \"language\": \"vi\"\n}",
        "options": {}
      },
      "id": "4e0f5f6e-cf8e-7e5e-df7f-6f9f0e1f2f3f",
      "name": "Search Medical Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 200]
    },
    {
      "parameters": {
        "jsCode": "// X·ª≠ l√Ω k·∫øt qu·∫£ t√¨m ki·∫øm thu·ªëc t·ª´ database\nconst searchResults = $input.all()[0].json;\nconst userData = $('Process User Input').all()[0].json;\n\nlet response = {\n  success: true,\n  userId: userData.userId,\n  sessionId: userData.sessionId,\n  intent: userData.intent,\n  recommendations: [],\n  message: '',\n  timestamp: new Date().toISOString()\n};\n\nif (searchResults.drugs && searchResults.drugs.length > 0) {\n  // L·∫•y top 3 thu·ªëc ph√π h·ª£p nh·∫•t\n  const topDrugs = searchResults.drugs.slice(0, 3);\n  \n  response.recommendations = topDrugs.map(drug => ({\n    drugName: drug.drug_name,\n    condition: drug.condition_vi || drug.medical_condition,\n    description: drug.description_vi ? \n      drug.description_vi.substring(0, 200) + '...' : \n      'Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt',\n    drugClass: drug.drug_class_vi || drug.drug_classes,\n    rxOtc: drug.rx_otc,\n    rating: drug.rating,\n    sideEffects: drug.side_effects_vi ? \n      drug.side_effects_vi.substring(0, 150) + '...' : \n      'Vui l√≤ng tham kh·∫£o b√°c sƒ© v·ªÅ t√°c d·ª•ng ph·ª•'\n  }));\n  \n  // T·∫°o message t·ª± nhi√™n\n  const symptomsText = userData.symptoms.join(', ').replace(/_/g, ' ');\n  response.message = `üè• **T∆∞ v·∫•n y t·∫ø cho tri·ªáu ch·ª©ng: ${symptomsText}**\\n\\n` +\n    `D·ª±a tr√™n tri·ªáu ch·ª©ng b·∫°n m√¥ t·∫£, t√¥i g·ª£i √Ω ${topDrugs.length} lo·∫°i thu·ªëc ph√π h·ª£p:\\n\\n`;\n  \n  topDrugs.forEach((drug, index) => {\n    response.message += `**${index + 1}. ${drug.drug_name}** ${drug.rx_otc === 'OTC' ? '(Kh√¥ng c·∫ßn toa)' : '(C·∫ßn toa b√°c sƒ©)'}\\n`;\n    response.message += `üìã ƒêi·ªÅu tr·ªã: ${drug.condition_vi || drug.medical_condition}\\n`;\n    response.message += `‚≠ê ƒê√°nh gi√°: ${drug.rating}/10\\n`;\n    response.message += `üíä Nh√≥m thu·ªëc: ${drug.drug_class_vi || drug.drug_classes}\\n\\n`;\n  });\n  \n  response.message += `‚ö†Ô∏è **L∆∞u √Ω quan tr·ªçng:**\\n` +\n    `‚Ä¢ ƒê√¢y ch·ªâ l√† t∆∞ v·∫•n tham kh·∫£o\\n` +\n    `‚Ä¢ Vui l√≤ng tham kh·∫£o √Ω ki·∫øn b√°c sƒ© tr∆∞·ªõc khi s·ª≠ d·ª•ng\\n` +\n    `‚Ä¢ ƒê·ªçc k·ªπ h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng tr√™n bao b√¨\\n` +\n    `‚Ä¢ Kh√¥ng t·ª± √Ω tƒÉng gi·∫£m li·ªÅu l∆∞·ª£ng`;\n    \n} else {\n  response.success = false;\n  response.message = `‚ùì **Kh√¥ng t√¨m th·∫•y thu·ªëc ph√π h·ª£p**\\n\\n` +\n    `R·∫•t ti·∫øc, t√¥i ch∆∞a t√¨m ƒë∆∞·ª£c thu·ªëc ph√π h·ª£p v·ªõi tri·ªáu ch·ª©ng \"${userData.originalMessage}\".\\n\\n` +\n    `üè• **G·ª£i √Ω:**\\n` +\n    `‚Ä¢ M√¥ t·∫£ chi ti·∫øt h∆°n v·ªÅ tri·ªáu ch·ª©ng\\n` +\n    `‚Ä¢ ThƒÉm kh√°m tr·ª±c ti·∫øp t·∫°i ph√≤ng kh√°m\\n` +\n    `‚Ä¢ G·ªçi hotline t∆∞ v·∫•n y t·∫ø: 19003456\\n\\n` +\n    `üí¨ **V√≠ d·ª• c√¢u h·ªèi t·ªët:**\\n` +\n    `\"T√¥i b·ªã ƒëau ƒë·∫ßu v√† s·ªët nh·∫π\"\\n` +\n    `\"Con t√¥i b·ªã ho khan t·ª´ 3 ng√†y nay\"`;\n}\n\nreturn { json: response };"
      },
      "id": "5f1e6e7f-de9f-8f6f-ee8f-7e0e1f2f3e4f",
      "name": "Process Drug Recommendations",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1540, 200]
    },
    {
      "parameters": {
        "jsCode": "// X·ª≠ l√Ω c√°c √Ω ƒë·ªãnh kh√°c (kh√¥ng ph·∫£i tri·ªáu ch·ª©ng)\nconst userdata = $('Process User Input').all()[0].json;\n\nlet response = {\n  success: true,\n  userId: userdata.userId,\n  sessionId: userdata.sessionId,\n  intent: userdata.intent,\n  message: '',\n  timestamp: new Date().toISOString()\n};\n\nswitch(userdata.intent) {\n  case 'side_effects_inquiry':\n    response.message = `üíä **H·ªèi v·ªÅ t√°c d·ª•ng ph·ª•**\\n\\n` +\n      `ƒê·ªÉ t∆∞ v·∫•n v·ªÅ t√°c d·ª•ng ph·ª•, t√¥i c·∫ßn bi·∫øt t√™n thu·ªëc c·ª• th·ªÉ.\\n\\n` +\n      `üîç **Vui l√≤ng cung c·∫•p:**\\n` +\n      `‚Ä¢ T√™n thu·ªëc ch√≠nh x√°c\\n` +\n      `‚Ä¢ Tri·ªáu ch·ª©ng b·∫°n ƒëang g·∫∑p\\n` +\n      `‚Ä¢ Th·ªùi gian s·ª≠ d·ª•ng thu·ªëc\\n\\n` +\n      `üí¨ **V√≠ d·ª•:** \"Paracetamol c√≥ t√°c d·ª•ng ph·ª• g√¨?\"`;\n    break;\n    \n  case 'dosage_inquiry':\n    response.message = `üìã **H·ªèi v·ªÅ li·ªÅu d√πng**\\n\\n` +\n      `Li·ªÅu d√πng thu·ªëc ph·ª• thu·ªôc v√†o nhi·ªÅu y·∫øu t·ªë:\\n\\n` +\n      `üë§ **Th√¥ng tin c·∫ßn thi·∫øt:**\\n` +\n      `‚Ä¢ Tu·ªïi v√† c√¢n n·∫∑ng\\n` +\n      `‚Ä¢ T√¨nh tr·∫°ng s·ª©c kh·ªèe hi·ªán t·∫°i\\n` +\n      `‚Ä¢ C√°c thu·ªëc ƒëang d√πng k√®m\\n\\n` +\n      `‚ö†Ô∏è **Khuy·∫øn c√°o:** Lu√¥n tu√¢n theo ch·ªâ ƒë·ªãnh c·ªßa b√°c sƒ© ho·∫∑c h∆∞·ªõng d·∫´n tr√™n bao b√¨ thu·ªëc.`;\n    break;\n    \n  case 'drug_interaction':\n    response.message = `‚ö†Ô∏è **T∆∞∆°ng t√°c thu·ªëc**\\n\\n` +\n      `T∆∞∆°ng t√°c thu·ªëc c√≥ th·ªÉ nguy hi·ªÉm. C·∫ßn th√¥ng tin chi ti·∫øt:\\n\\n` +\n      `üíä **C·∫ßn bi·∫øt:**\\n` +\n      `‚Ä¢ Danh s√°ch t·∫•t c·∫£ thu·ªëc ƒëang d√πng\\n` +\n      `‚Ä¢ Th·ª±c ph·∫©m ch·ª©c nƒÉng, vitamin\\n` +\n      `‚Ä¢ T√¨nh tr·∫°ng b·ªánh l√Ω\\n\\n` +\n      `üè• **Khuy·∫øn ngh·ªã:** Tham kh·∫£o d∆∞·ª£c sƒ© ho·∫∑c b√°c sƒ© ƒë·ªÉ ki·ªÉm tra t∆∞∆°ng t√°c thu·ªëc an to√†n.`;\n    break;\n    \n  default:\n    response.message = `üëã **Ch√†o m·ª´ng ƒë·∫øn v·ªõi Medical Chatbot!**\\n\\n` +\n      `üè• T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:\\n` +\n      `‚Ä¢ T∆∞ v·∫•n thu·ªëc kh√¥ng c·∫ßn toa cho tri·ªáu ch·ª©ng th∆∞·ªùng g·∫∑p\\n` +\n      `‚Ä¢ Th√¥ng tin v·ªÅ t√°c d·ª•ng ph·ª•\\n` +\n      `‚Ä¢ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng thu·ªëc c∆° b·∫£n\\n\\n` +\n      `üí¨ **V√≠ d·ª• c√¢u h·ªèi:**\\n` +\n      `\"T√¥i b·ªã ƒëau ƒë·∫ßu, n√™n u·ªëng thu·ªëc g√¨?\"\\n` +\n      `\"Thu·ªëc paracetamol c√≥ t√°c d·ª•ng ph·ª• g√¨?\"\\n` +\n      `\"T√¥i b·ªã ho khan, c√≥ thu·ªëc OTC n√†o kh√¥ng?\"\\n\\n` +\n      `‚ö†Ô∏è **L∆∞u √Ω:** ƒê√¢y ch·ªâ l√† t∆∞ v·∫•n tham kh·∫£o, kh√¥ng thay th·∫ø √Ω ki·∫øn b√°c sƒ© chuy√™n khoa.`;\n}\n\nreturn { json: response };"
      },
      "id": "6e2f7f8e-ef0e-9e7e-ff9e-8f1f2f3f4f5f",
      "name": "Handle General Inquiries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "7f3e8e9f-fe1f-af8f-ee0f-9f2f3f4f5f6f",
      "name": "Send Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "url": "http://localhost:8000/api/log-conversation",
        "sendQuery": false,
        "sendHeaders": false,
        "sendBody": true,
        "contentType": "json",
        "body": "={\n  \"userId\": \"{{ $json.userId }}\",\n  \"sessionId\": \"{{ $json.sessionId }}\",\n  \"intent\": \"{{ $json.intent }}\",\n  \"userMessage\": \"{{ $('Process User Input').all()[0].json.originalMessage }}\",\n  \"botResponse\": {{ JSON.stringify($json.message) }},\n  \"recommendations\": {{ JSON.stringify($json.recommendations || []) }},\n  \"timestamp\": \"{{ $json.timestamp }}\",\n  \"success\": {{ $json.success }}\n}",
        "options": {
          "redirect": {},\n          "timeout": 10000\n        }\n      },\n      \"id\": \"8e4f9f0f-ef2f-bf9f-ff1f-af3f4f5f6f7f\",\n      \"name\": \"Log Conversation\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.1,\n      \"position\": [1780, 500],\n      \"continueOnFail\": true\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"When clicking 'Test workflow'\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Process User Input\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Webhook - Chat Input\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Process User Input\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Process User Input\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Route by Intent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Route by Intent\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Search Medical Database\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Handle General Inquiries\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Search Medical Database\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Process Drug Recommendations\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Process Drug Recommendations\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Log Conversation\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Handle General Inquiries\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Log Conversation\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"active\": false,\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"1.0.0\",\n  \"meta\": {\n    \"templateCredsSetupCompleted\": true,\n    \"instanceId\": \"medical-chatbot-workflow\"\n  },\n  \"id\": \"medical-chatbot-workflow\",\n  \"tags\": [\n    {\n      \"createdAt\": \"2025-10-10T10:00:00.000Z\",\n      \"updatedAt\": \"2025-10-10T10:00:00.000Z\",\n      \"id\": \"medical-ai\",\n      \"name\": \"Medical AI\"\n    }\n  ]\n}